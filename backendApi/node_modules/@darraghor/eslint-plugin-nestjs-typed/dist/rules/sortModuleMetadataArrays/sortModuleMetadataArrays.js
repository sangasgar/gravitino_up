"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getRelevantNodeName = exports.isValidModuleMetaPropertyType = void 0;
const utils_1 = require("@typescript-eslint/utils");
const createRule_1 = require("../../utils/createRule");
const wellKnownSelectors_1 = require("../../utils/wellKnownSelectors");
const utils_2 = require("@typescript-eslint/utils");
// Inspired by https://github.com/angular-eslint/angular-eslint/blob/main/packages/eslint-plugin/src/rules/sort-ngmodule-metadata-arrays.ts
const DEFAULT_LOCALE = "en-US";
const isValidModuleMetaPropertyType = (node) => {
    // eslint-disable-next-line @typescript-eslint/no-unsafe-return
    return (!!node &&
        utils_2.ASTUtils.isNodeOfTypes([
            utils_1.TSESTree.AST_NODE_TYPES.Identifier,
            utils_1.TSESTree.AST_NODE_TYPES.CallExpression,
            // eslint-disable-next-line @typescript-eslint/no-explicit-any
        ])); // unsure about this type
};
exports.isValidModuleMetaPropertyType = isValidModuleMetaPropertyType;
const getRelevantNodeName = (node) => {
    let currentName = "";
    if (node.type === utils_1.TSESTree.AST_NODE_TYPES.Identifier) {
        currentName = node.name;
    }
    if (node.type === utils_1.TSESTree.AST_NODE_TYPES.CallExpression &&
        node.callee.type === utils_1.TSESTree.AST_NODE_TYPES.MemberExpression &&
        node.callee.object.type === utils_1.TSESTree.AST_NODE_TYPES.Identifier) {
        currentName = node.callee.object.name;
    }
    return currentName;
};
exports.getRelevantNodeName = getRelevantNodeName;
const defaultLocaleOptions = [
    {
        locale: DEFAULT_LOCALE,
    },
];
exports.default = (0, createRule_1.createRule)({
    name: "sort-module-metadata-arrays",
    meta: {
        type: "suggestion",
        docs: {
            description: "Ensures ASC alphabetical order for `Module` metadata arrays for easy visual scanning",
        },
        fixable: "code",
        schema: [
            {
                type: "object",
                properties: {
                    locale: {
                        type: "string",
                        description: "A string with a BCP 47 language tag.",
                        default: DEFAULT_LOCALE,
                    },
                },
                additionalProperties: false,
            },
        ],
        messages: {
            moduleMetadataArraysAreSorted: "`Module` metadata arrays should be sorted in ASC alphabetical order",
        },
    },
    defaultOptions: defaultLocaleOptions,
    create(contextWithoutDefaults) {
        const context = contextWithoutDefaults.options &&
            contextWithoutDefaults.options.length > 0
            ? contextWithoutDefaults
            : // only apply the defaults when the user provides no config
                Object.setPrototypeOf({
                    options: defaultLocaleOptions,
                }, contextWithoutDefaults);
        const { locale } = context.options[0];
        const sourceCode = context.getSourceCode();
        return {
            [`${wellKnownSelectors_1.MODULE_CLASS_DECORATOR} Property > ArrayExpression`]({ elements, }) {
                const unorderedNodes = elements
                    // nestjs modules use identifiers and call expressions
                    // can modify this later
                    .filter(exports.isValidModuleMetaPropertyType)
                    .map((current, index, list) => [current, list[index + 1]])
                    .find(([current, next]) => {
                    return (current &&
                        next &&
                        (0, exports.getRelevantNodeName)(current).localeCompare((0, exports.getRelevantNodeName)(next), locale) === 1);
                });
                if (!unorderedNodes)
                    return;
                const [unorderedNode, nextNode] = unorderedNodes;
                context.report({
                    node: nextNode,
                    messageId: "moduleMetadataArraysAreSorted",
                    fix: (fixer) => [
                        fixer.replaceText(unorderedNode, sourceCode.getText(nextNode)),
                        fixer.replaceText(nextNode, sourceCode.getText(unorderedNode)),
                    ],
                });
            },
        };
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic29ydE1vZHVsZU1ldGFkYXRhQXJyYXlzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3J1bGVzL3NvcnRNb2R1bGVNZXRhZGF0YUFycmF5cy9zb3J0TW9kdWxlTWV0YWRhdGFBcnJheXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsb0RBQWtEO0FBQ2xELHVEQUFrRDtBQUNsRCx1RUFBc0U7QUFDdEUsb0RBQWtEO0FBRWxELDJJQUEySTtBQUUzSSxNQUFNLGNBQWMsR0FBRyxPQUFPLENBQUM7QUFZeEIsTUFBTSw2QkFBNkIsR0FBRyxDQUN6QyxJQUF5RCxFQUM3QixFQUFFO0lBQzlCLCtEQUErRDtJQUMvRCxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUk7UUFDVixnQkFBUSxDQUFDLGFBQWEsQ0FBQztZQUNuQixnQkFBUSxDQUFDLGNBQWMsQ0FBQyxVQUFVO1lBQ2xDLGdCQUFRLENBQUMsY0FBYyxDQUFDLGNBQWM7WUFDdEMsOERBQThEO1NBQ2pFLENBQUMsQ0FBUSxDQUFDLENBQUMseUJBQXlCO0FBQzdDLENBQUMsQ0FBQztBQVZXLFFBQUEsNkJBQTZCLGlDQVV4QztBQUNLLE1BQU0sbUJBQW1CLEdBQUcsQ0FBQyxJQUFtQixFQUFFLEVBQUU7SUFDdkQsSUFBSSxXQUFXLEdBQUcsRUFBRSxDQUFDO0lBRXJCLElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxnQkFBUSxDQUFDLGNBQWMsQ0FBQyxVQUFVLEVBQUU7UUFDbEQsV0FBVyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7S0FDM0I7SUFDRCxJQUNJLElBQUksQ0FBQyxJQUFJLEtBQUssZ0JBQVEsQ0FBQyxjQUFjLENBQUMsY0FBYztRQUNwRCxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksS0FBSyxnQkFBUSxDQUFDLGNBQWMsQ0FBQyxnQkFBZ0I7UUFDN0QsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxLQUFLLGdCQUFRLENBQUMsY0FBYyxD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